name: Automated Release Management

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      pre_release:
        description: 'Create pre-release'
        required: false
        default: false
        type: boolean
      generate_changelog:
        description: 'Generate changelog'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '20'
  GIT_USER: 'github-actions[bot]'
  GIT_EMAIL: 'github-actions[bot]@users.noreply.github.com'

permissions:
  contents: write
  pull-requests: write
  releases: write
  packages: write

jobs:
  # Version analysis and change detection
  version-analysis:
    name: Version Analysis
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.version.outputs.current }}
      next_version: ${{ steps.version.outputs.next }}
      version_bump: ${{ steps.version.outputs.bump }}
      should_release: ${{ steps.changes.outputs.should_release }}
      changelog_generated: ${{ steps.changelog.outputs.generated }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Analyze Current Version
        id: version
        run: |
          echo "ðŸ“Š Analyzing version information..."

          CURRENT_VERSION=$(node -e "console.log(require('./package.json').version)")
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

          # Determine version bump type
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BUMP_TYPE="${{ github.event.inputs.release_type }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # Auto-detect based on conventional commits
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            COMMITS_SINCE_TAG=$(git log $LAST_TAG..HEAD --oneline --no-merges)

            if echo "$COMMITS_SINCE_TAG" | grep -q "feat"; then
              if echo "$COMMITS_SINCE_TAG" | grep -q "BREAKING CHANGE"; then
                BUMP_TYPE="major"
              else
                BUMP_TYPE="minor"
              fi
            elif echo "$COMMITS_SINCE_TAG" | grep -q "fix"; then
              BUMP_TYPE="patch"
            else
              BUMP_TYPE="patch"  # Default to patch
            fi
          else
            BUMP_TYPE="patch"
          fi

          echo "bump=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "Version bump type: $BUMP_TYPE"

          # Calculate next version
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}

          case $BUMP_TYPE in
            "major")
              NEXT_VERSION="$((MAJOR + 1)).0.0"
              ;;
            "minor")
              NEXT_VERSION="${MAJOR}.$((MINOR + 1)).0"
              ;;
            "patch")
              NEXT_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
              ;;
          esac

          echo "next=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "Next version: $NEXT_VERSION"

      - name: Detect Changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            release:
              - 'package.json'
              - 'src/**'
              - 'templates/**'
              - 'CHANGELOG.md'
              - 'README.md'

      - name: Check if Release Should Be Created
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" || ("${{ github.ref }}" == "refs/heads/main" && "${{ steps.changes.outputs.release }}" == "true") ]]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "âœ… Release should be created"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ No release needed"
          fi

      - name: Generate Changelog
        id: changelog
        if: steps.version.outputs.should_release == 'true' && github.event.inputs.generate_changelog != 'false'
        run: |
          echo "ðŸ“ Generating changelog..."

          # Install conventional changelog generator
          npm install -g conventional-changelog-cli conventional-changelog-conventionalcommits

          # Generate changelog
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")

          conventional-changelog -p angular -i CHANGELOG.md -s

          # Add version header
          sed -i "s/^## \[Unreleased\]/## [${{ steps.version.outputs.next }}] - $(date +'%Y-%m-%d')/" CHANGELOG.md

          echo "generated=true" >> $GITHUB_OUTPUT
          echo "âœ… Changelog generated"

      - name: Commit Changelog Changes
        if: steps.changelog.outputs.generated == 'true'
        run: |
          git config user.name "${{ env.GIT_USER }}"
          git config user.email "${{ env.GIT_EMAIL }}"

          git add CHANGELOG.md
          git commit -m "chore: update changelog for ${{ steps.version.outputs.next }}"
          git push

  # Comprehensive testing before release
  pre-release-testing:
    name: Pre-release Testing
    runs-on: ubuntu-latest
    needs: version-analysis
    if: needs.version-analysis.outputs.should_release == 'true'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Run Comprehensive Test Suite
        run: |
          echo "ðŸ§ª Running pre-release test suite..."

          # Build project
          npm run build

          # Run all tests
          npm run test:coverage

          # Run linting and type checking
          npm run lint
          npm run typecheck

          # Test CLI functionality
          node dist/cli.js --version
          node dist/cli.js --help

          # Test project generation
          mkdir -p test-release
          cd test-release
          ../dist/cli.js init --template none --default --no-interactive || echo "Interactive mode required"
          cd ..
          rm -rf test-release

          echo "âœ… Pre-release testing completed"

      - name: Security Audit
        run: |
          echo "ðŸ”’ Running security audit..."
          npm audit --audit-level=moderate
          echo "âœ… Security audit completed"

  # Version bump and package preparation
  version-bump:
    name: Version Bump & Preparation
    runs-on: ubuntu-latest
    needs: [version-analysis, pre-release-testing]
    if: needs.version-analysis.outputs.should_release == 'true'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Update Package Version
        run: |
          echo "ðŸ“¦ Updating package version to ${{ needs.version-analysis.outputs.next_version }}..."

          # Update package.json
          npm version ${{ needs.version-analysis.outputs.next_version }} --no-git-tag-version

          # Verify version update
          NEW_VERSION=$(node -e "console.log(require('./package.json').version)")
          echo "Updated to: $NEW_VERSION"

          if [[ "$NEW_VERSION" != "${{ needs.version-analysis.outputs.next_version }}" ]]; then
            echo "âŒ Version update failed"
            exit 1
          fi

      - name: Update Build Metadata
        run: |
          echo "ðŸ”§ Updating build metadata..."

          # Update any version references in documentation
          find . -name "*.md" -not -path "./node_modules/*" -exec sed -i "s/v${{ needs.version-analysis.outputs.current_version }}/v${{ needs.version-analysis.outputs.next_version }}/g" {} \;

          # Update README installation examples
          if [[ -f "README.md" ]]; then
            sed -i "s/@dcversus\/prp@.*/@dcversus\/prp@${{ needs.version-analysis.outputs.next_version }}/g" README.md
          fi

      - name: Commit Version Changes
        run: |
          git config user.name "${{ env.GIT_USER }}"
          git config user.email "${{ env.GIT_EMAIL }}"

          git add package.json package-lock.json
          git add README.md CHANGELOG.md 2>/dev/null || true

          git commit -m "chore(release): ${{ needs.version-analysis.outputs.next_version }}"
          git push

      - name: Create Git Tag
        run: |
          echo "ðŸ·ï¸ Creating git tag v${{ needs.version-analysis.outputs.next_version }}..."

          git tag -a "v${{ needs.version-analysis.outputs.next_version }}" -m "Release ${{ needs.version-analysis.outputs.next_version }}"
          git push origin "v${{ needs.version-analysis.outputs.next_version }}"

  # Build and create release artifacts
  release-build:
    name: Release Build & Artifacts
    runs-on: ubuntu-latest
    needs: version-bump

    outputs:
      artifact_name: ${{ steps.package.outputs.artifact_name }}
      release_version: ${{ needs.version-analysis.outputs.next_version }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: 'v${{ needs.version-analysis.outputs.next_version }}'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Build Release Package
        run: |
          echo "ðŸ—ï¸ Building release package..."

          npm run build

          # Create distribution directory
          mkdir -p release-package

          # Copy essential files
          cp -r dist/ release-package/
          cp package.json release-package/
          cp README.md release-package/ 2>/dev/null || echo "README.md not found"
          cp LICENSE release-package/ 2>/dev/null || echo "LICENSE not found"
          cp CHANGELOG.md release-package/ 2>/dev/null || echo "CHANGELOG.md not found"

      - name: Create Release Artifacts
        id: package
        run: |
          echo "ðŸ“¦ Creating release artifacts..."

          # Create tarball
          tar -czf "prp-cli-v${{ needs.version-analysis.outputs.next_version }}.tar.gz" -C release-package .

          # Create zip for Windows users
          cd release-package
          zip -r "../prp-cli-v${{ needs.version-analysis.outputs.next_version }}.zip" .
          cd ..

          # Create artifact name
          ARTIFACT_NAME="prp-release-v${{ needs.version-analysis.outputs.next_version }}"
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

          echo "âœ… Release artifacts created"

      - name: Test Release Package
        run: |
          echo "ðŸ§ª Testing release package..."

          cd release-package

          # Test CLI functionality
          node dist/cli.js --version
          node dist/cli.js --help

          cd ..

          echo "âœ… Release package tested"

      - name: Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.artifact_name }}
          path: |
            prp-cli-v${{ needs.version-analysis.outputs.next_version }}.tar.gz
            prp-cli-v${{ needs.version-analysis.outputs.next_version }}.zip
            release-package/
          retention-days: 90

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [version-analysis, release-build]
    if: needs.version-analysis.outputs.should_release == 'true'

    environment:
      name: production
      url: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.version-analysis.outputs.next_version }}

    steps:
      - name: Download Release Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.release-build.outputs.artifact_name }}
          path: ./artifacts

      - name: Generate Release Notes
        id: release_notes
        run: |
          echo "ðŸ“ Generating release notes..."

          LAST_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "v0.0.0")
          RELEASE_NOTES=$(git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)

          # Add changelog excerpt if available
          if [[ -f "CHANGELOG.md" ]]; then
            CHANGELOG_EXCERPT=$(sed -n "/## \[${{ needs.version-analysis.outputs.next_version }}\]/,/^## /p" CHANGELOG.md | sed '$d')
            RELEASE_NOTES="$RELEASE_NOTES\n\n### Changes\n$CHANGELOG_EXCERPT"
          fi

          # Create release body
          cat > release_body.md << EOF
          ## ðŸŽ‰ PRP CLI v${{ needs.version-analysis.outputs.next_version }}

          ### ðŸ“¦ Installation

          **NPM:**
          \`\`\`bash
          npm install -g @dcversus/prp@${{ needs.version-analysis.outputs.next_version }}
          \`\`\`

          **Download:**
          - [tar.gz](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version-analysis.outputs.next_version }}/prp-cli-v${{ needs.version-analysis.outputs.next_version }}.tar.gz)
          - [zip](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version-analysis.outputs.next_version }}/prp-cli-v${{ needs.version-analysis.outputs.next_version }}.zip)

          **Docker:**
          \`\`\`bash
          docker pull ghcr.io/${{ github.repository }}:v${{ needs.version-analysis.outputs.next_version }}
          \`\`\`

          ### ðŸ“‹ Changes

          $RELEASE_NOTES

          ---

          **Full Changelog:** [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          EOF

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_body.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: 'v${{ needs.version-analysis.outputs.next_version }}'
          name: 'PRP CLI v${{ needs.version-analysis.outputs.next_version }}'
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: ${{ github.event.inputs.pre_release == 'true' }}
          files: |
            ./artifacts/prp-cli-v${{ needs.version-analysis.outputs.next_version }}.tar.gz
            ./artifacts/prp-cli-v${{ needs.version-analysis.outputs.next_version }}.zip
          generate_release_notes: true

  # Publish to NPM
  npm-publish:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: [version-analysis, create-release]
    if: needs.version-analysis.outputs.should_release == 'true'

    environment:
      name: production
      url: https://www.npmjs.com/package/@dcversus/prp

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: 'v${{ needs.version-analysis.outputs.next_version }}'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install Dependencies
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Build Package
        run: npm run build

      - name: Publish to NPM
        run: |
          echo "ðŸš€ Publishing to NPM..."

          # Verify package before publishing
          npm pack --dry-run

          # Publish to NPM
          npm publish --access public --tag ${{ github.event.inputs.pre_release == 'true' && 'next' || 'latest' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify NPM Publication
        run: |
          echo "âœ… Verifying NPM publication..."

          PACKAGE_NAME="@dcversus/prp"
          VERSION="${{ needs.version-analysis.outputs.next_version }}"
          TAG="${{ github.event.inputs.pre_release == 'true' && 'next' || 'latest' }}"

          # Wait for package to be available
          timeout 60s bash -c "until npm view \"$PACKAGE_NAME@$VERSION\" >/dev/null 2>&1; do sleep 3; done"

          if npm view "$PACKAGE_NAME@$VERSION" >/dev/null 2>&1; then
            echo "âœ… Package $PACKAGE_NAME@$VERSION published successfully to $TAG tag"
          else
            echo "âŒ Package verification failed"
            exit 1
          fi

      - name: Update NPM Dist Tags
        if: github.event.inputs.pre_release != 'true'
        run: |
          echo "ðŸ·ï¸ Updating NPM dist tags..."

          # Ensure latest tag points to new version
          npm dist-tag add @dcversus/prp@${{ needs.version-analysis.outputs.next_version }} latest

  # Post-release notifications and cleanup
  post-release:
    name: Post-release Tasks
    runs-on: ubuntu-latest
    needs: [version-analysis, create-release, npm-publish]
    if: always() && needs.version-analysis.outputs.should_release == 'true'

    steps:
      - name: Generate Release Summary
        run: |
          echo "## ðŸŽ‰ Release Completed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${{ needs.version-analysis.outputs.next_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Type** | ${{ needs.version-analysis.outputs.version_bump }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Previous** | ${{ needs.version-analysis.outputs.current_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Release** | [v${{ needs.version-analysis.outputs.next_version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.version-analysis.outputs.next_version }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **NPM** | [@dcversus/prp@${{ needs.version-analysis.outputs.next_version }}](https://www.npmjs.com/package/@dcversus/prp/v/${{ needs.version-analysis.outputs.next_version }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸš€ Quick Start" >> $GITHUB_STEP_SUMMARY
          echo "```bash" >> $GITHUB_STEP_SUMMARY
          echo "# Global installation" >> $GITHUB_STEP_SUMMARY
          echo "npm install -g @dcversus/prp" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Initialize a new project" >> $GITHUB_STEP_SUMMARY
          echo "prp init --template typescript" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Docker" >> $GITHUB_STEP_SUMMARY
          echo "```bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}:v${{ needs.version-analysis.outputs.next_version }}" >> $GITHUB_STEP_SUMMARY
          echo "docker run --rm -v \$(pwd):/workspace ghcr.io/${{ github.repository }}:v${{ needs.version-analysis.outputs.next_version }} init" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Docker Build
        if: needs.create-release.result == 'success'
        run: |
          echo "ðŸ‹ Triggering Docker build for new release..."

          # This would trigger the Docker workflow
          # GitHub Actions will automatically trigger on tag push
          echo "Docker build triggered by tag push v${{ needs.version-analysis.outputs.next_version }}"

      - name: Notify Teams (if configured)
        if: needs.create-release.result == 'success'
        run: |
          echo "ðŸ“¢ Release notification would be sent to configured channels"
          echo "Version: ${{ needs.version-analysis.outputs.next_version }}"
          echo "Release notes available at: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.version-analysis.outputs.next_version }}"

  # Release status summary
  release-status:
    name: Release Status
    runs-on: ubuntu-latest
    needs:
      [
        version-analysis,
        pre-release-testing,
        version-bump,
        release-build,
        create-release,
        npm-publish,
        post-release,
      ]
    if: always()

    steps:
      - name: Generate Release Pipeline Status
        run: |
          echo "## ðŸš€ Release Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version Analysis | ${{ needs.version-analysis.result }} | Version bump detection |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-release Testing | ${{ needs.pre-release-testing.result }} | Comprehensive testing |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Bump | ${{ needs.version-bump.result }} | Package version update |" >> $GITHUB_STEP_SUMMARY
          echo "| Release Build | ${{ needs.release-build.result }} | Artifact creation |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.create-release.result }} | Release creation |" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Publish | ${{ needs.npm-publish.result }} | Package publishing |" >> $GITHUB_STEP_SUMMARY
          echo "| Post-release | ${{ needs.post-release.result }} | Notifications & cleanup |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.create-release.result }}" == "success" && "${{ needs.npm-publish.result }}" == "success" ]]; then
            echo "### âœ… Release Pipeline Successful!" >> $GITHUB_STEP_SUMMARY
            echo "- Version ${{ needs.version-analysis.outputs.next_version }} released successfully" >> $GITHUB_STEP_SUMMARY
            echo "- GitHub release created" >> $GITHUB_STEP_SUMMARY
            echo "- Package published to NPM" >> $GITHUB_STEP_SUMMARY
            echo "- All artifacts uploaded" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Release Pipeline Failed!" >> $GITHUB_STEP_SUMMARY
            echo "- Check failed stages above" >> $GITHUB_STEP_SUMMARY
            echo "- Manual intervention may be required" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline for v${{ needs.version-analysis.outputs.next_version }}** | **Build:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
