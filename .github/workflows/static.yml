name: Deploy Static Site to GitHub Pages

on:
  push:
    branches: [main]
    paths:
      - 'index.html'
      - 'CNAME'
      - 'src/docs/**'
      - 'docs/**'
      - 'scripts/**'
      - 'package.json'
      - 'package-lock.json'
      - 'webpack.config.js'
      - '.github/workflows/static.yml'
  pull_request:
    branches: [main]
    paths:
      - 'index.html'
      - 'CNAME'
      - 'src/docs/**'
      - 'docs/**'
      - 'scripts/**'
      - 'package.json'
      - 'package-lock.json'
      - 'webpack.config.js'
      - '.github/workflows/static.yml'
  workflow_dispatch:
    inputs:
      deploy_preview:
        description: 'Deploy preview even for PRs'
        required: false
        default: 'false'
        type: boolean

# Grant GITHUB_TOKEN permissions to deploy to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Ensure only one deployment runs at a time
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for proper git info

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build documentation and landing page
        run: npm run build:docs

      - name: Verify build artifacts
        run: |
          echo "ğŸ“ Build directory structure:"
          find build/ -type f -name "*.html" | head -10
          echo ""
          echo "ğŸ” Search index verification:"
          if [ -f "build/assets/search-index.json" ]; then
            echo "âœ… Search index exists with $(jq length build/assets/search-index.json) pages"
          else
            echo "âŒ Search index missing"
            exit 1
          fi
          echo ""
          echo "ğŸ—ºï¸  Sitemap verification:"
          if [ -f "build/sitemap.xml" ]; then
            echo "âœ… Sitemap exists"
          else
            echo "âš ï¸  Sitemap missing (will be generated)"
          fi
          echo ""
          echo "ğŸŒ CNAME verification:"
          if [ -f "build/CNAME" ]; then
            echo "âœ… CNAME exists: $(cat build/CNAME)"
          else
            echo "âš ï¸  CNAME missing"
          fi

      - name: Generate sitemap.xml
        run: |
          BASE_URL="https://prp.theedgestory.org"
          BUILD_DIR="build"
          cat > "${BUILD_DIR}/sitemap.xml" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
            <url>
              <loc>${BASE_URL}/</loc>
              <lastmod>$(date -u '+%Y-%m-%d')</lastmod>
              <changefreq>weekly</changefreq>
              <priority>1.0</priority>
            </url>
          EOF

          # Add all HTML pages to sitemap
          find "${BUILD_DIR}" -name "*.html" -type f | while read file; do
            path=$(echo "$file" | sed "s|${BUILD_DIR}/||")
            url="${BASE_URL}/${path}"
            echo "    <url>
              <loc>${url}</loc>
              <lastmod>$(date -u '+%Y-%m-%d')</lastmod>
              <changefreq>weekly</changefreq>
              <priority>0.8</priority>
            </url>" >> "${BUILD_DIR}/sitemap.xml"
          done

          echo "</urlset>" >> "${BUILD_DIR}/sitemap.xml"
          echo "âœ… Sitemap generated with $(grep -c '<url>' "${BUILD_DIR}/sitemap.xml") pages"

      - name: Optimize build artifacts
        run: |
          echo "ğŸ“Š Build size analysis:"
          du -sh build/ || true
          echo ""
          echo "ğŸ—‚ï¸  Files by size:"
          find build/ -type f -exec du -h {} + | sort -hr | head -10
          echo ""
          echo "âš¡ Optimization complete"

      - name: Upload build artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: build

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_preview == 'true')

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment Summary
        run: |
          echo "## ğŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Site URL** | [${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployed by** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployed at** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- Landing page with musical theme (â™«) deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation sub-pages generated" >> $GITHUB_STEP_SUMMARY
          echo "- Search index and sitemap created" >> $GITHUB_STEP_SUMMARY
          echo "- Responsive design optimized" >> $GITHUB_STEP_SUMMARY

      - name: Report deployment status to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const page_url = '${{ steps.deployment.outputs.page_url }}';
            const issue_number = context.issue.number;

            const comment_body = `## ğŸš€ Preview Deployment Ready

            Your landing page and documentation changes have been deployed!

            ğŸŒ **Preview URL**: [${page_url}](${page_url})

            ### ğŸ“‹ Changes Deployed:
            - âœ… Landing page with musical theme (â™«)
            - âœ… Documentation sub-pages with consistent branding
            - âœ… Search functionality across all pages
            - âœ… Responsive design for mobile devices
            - âœ… SEO optimization with sitemap

            â° **Deployed**: ${new Date().toISOString()}
            ğŸ‘¤ **Deployed by**: @${{ github.actor }}

            ---

            *This preview will be available until the PR is closed. Changes will be published to the main site when merged.*`;

            // Find existing bot comment or create new one
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview Deployment Ready')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment_body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: comment_body,
              });
            }

      - name: Notify deployment success
        run: |
          echo "ğŸ‰ Landing page CI/CD deployment completed successfully!"
          echo "ğŸŒ Live URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“± Mobile responsive: Yes"
          echo "ğŸ” Search enabled: Yes"
          echo "ğŸµ Musical theme (â™«): Applied consistently"
          echo "ğŸ“Š Pages deployed: $(find build/ -name '*.html' | wc -l)"