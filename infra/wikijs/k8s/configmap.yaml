# ConfigMap for Wiki.js configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: wikijs-config
  namespace: wikijs
  labels:
    app: wikijs
    component: config
data:
  config.yml: |
    # Wiki.js Production Configuration
    # Auto-generated by PRP Wiki.js template

    # Database
    database:
      type: postgres
      host: postgres
      port: 5432
      user: wikijs
      db: wikijs
      ssl: false

    # Redis Cache
    redis:
      host: redis
      port: 6379
      password: ""

    # Security
    security:
      trustProxy: true
      ssl: false
      sessionSecret: ""

    # Logging
    logLevel: info
    logFormat: json

    # Performance
    maxUploadSize: 52428800
    searchMaxHits: 50

    # Features
    features:
      ratings: true
      comments: true
      pageRatings: true

    # Mail (optional)
    mail:
      host: ""
      port: 587
      secure: false
      user: ""
      pass: ""
      fromName: "Wiki.js"
      fromEmail: ""

    # Authentication
    authentication:
      enabled: true
      local:
        enabled: true
        allowRegistration: false

    # Theme
    theme:
      primary: indigo
      alt: blue-grey

    # SEO
    seo:
      description: "Knowledge base powered by Wiki.js"
      robots: "index, follow"

  # Nginx configuration
  nginx.conf: |
    upstream wikijs {
        server wikijs-service:3000;
    }

    server {
        listen 80;
        server_name _;

        location / {
            proxy_pass http://wikijs;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }

  # Backup script
  backup.sh: |
    #!/bin/bash
    set -euo pipefail

    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="/backups/wikijs_backup_${TIMESTAMP}.sql"

    pg_dump -h postgres -U wikijs -d wikijs > "$BACKUP_FILE"
    gzip "$BACKUP_FILE"

    # Keep only last 30 days
    find /backups -name "wikijs_backup_*.sql.gz" -mtime +30 -delete

    echo "Backup completed: ${BACKUP_FILE}.gz"